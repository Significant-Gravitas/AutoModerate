{% extends "base.html" %}

{% block title %}System Logs - Admin - AutoModerate{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">System Logs</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('admin.index') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Admin
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recent Content -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Content Activity</h5>
            </div>
            <div class="card-body">
                {% if recent_content %}
                <div class="list-group list-group-flush">
                    {% for content in recent_content %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="text-truncate" style="max-width: 300px;" title="{{ content.content_data }}">
                                    <strong>{{ content.content_data[:50] }}...</strong>
                                </div>
                                <small class="text-muted">
                                    Project: {{ content.project.name }} |
                                    User: {{ content.project.owner.username }}
                                </small>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ content.created_at.strftime('%H:%M') }}</small>
                                <br>
                                <small class="text-muted">{{ content.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No recent content activity.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Moderations -->
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Recent Moderation Activity</h5>
            </div>
            <div class="card-body">
                {% if recent_moderations %}
                <div class="list-group list-group-flush">
                    {% for moderation in recent_moderations %}
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="text-truncate" style="max-width: 300px;" title="{{ moderation.content.content_data }}">
                                    <strong>{{ moderation.content.content_data[:50] }}...</strong>
                                </div>
                                <small class="text-muted">
                                    Project: {{ moderation.content.project.name }} |
                                    {% if moderation.moderator_type == 'rule' and moderation.rule %}
                                        Rule: {{ moderation.rule.name }}
                                    {% elif moderation.moderator_type == 'ai' %}
                                        AI Moderation
                                    {% else %}
                                        Manual Review
                                    {% endif %}
                                </small>
                                <br>
                                <span class="badge bg-{% if moderation.decision == 'approved' %}success{% elif moderation.decision == 'rejected' %}danger{% else %}warning{% endif %}">
                                    {{ moderation.decision|title }}
                                </span>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">{{ moderation.created_at.strftime('%H:%M') }}</small>
                                <br>
                                <small class="text-muted">{{ moderation.created_at.strftime('%Y-%m-%d') }}</small>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <p class="text-muted text-center">No recent moderation activity.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Activity Timeline -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Activity Timeline</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% set all_activities = [] %}
                    {% for content in recent_content %}
                        {% set _ = all_activities.append({
                            'type': 'content',
                            'item': content,
                            'time': content.created_at,
                            'icon': 'fas fa-file-alt',
                            'color': 'text-info'
                        }) %}
                    {% endfor %}
                    {% for moderation in recent_moderations %}
                        {% set _ = all_activities.append({
                            'type': 'moderation',
                            'item': moderation,
                            'time': moderation.created_at,
                            'icon': 'fas fa-shield-alt',
                            'color': 'text-warning'
                        }) %}
                    {% endfor %}

                    {% set sorted_activities = all_activities|sort(attribute='time', reverse=true) %}

                    {% if sorted_activities %}
                        {% for activity in sorted_activities[:20] %}
                        <div class="timeline-item">
                            <div class="timeline-marker">
                                <i class="{{ activity.icon }} {{ activity.color }}"></i>
                            </div>
                            <div class="timeline-content">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        {% if activity.type == 'content' %}
                                            <strong>Content Created</strong>
                                            <br>
                                                                                         <small class="text-muted">
                                                 "{{ activity.item.content_data[:100] }}{% if activity.item.content_data|length > 100 %}...{% endif %}"
                                             </small>
                                            <br>
                                            <small class="text-muted">
                                                Project: {{ activity.item.project.name }} |
                                                User: {{ activity.item.project.owner.username }}
                                            </small>
                                        {% else %}
                                            <strong>Content Moderated</strong>
                                            <br>
                                                                                         <small class="text-muted">
                                                 "{{ activity.item.content.content_data[:100] }}{% if activity.item.content.content_data|length > 100 %}...{% endif %}"
                                             </small>
                                            <br>
                                                                                         <small class="text-muted">
                                                 Decision:
                                                 <span class="badge bg-{% if activity.item.decision == 'approved' %}success{% elif activity.item.decision == 'rejected' %}danger{% else %}warning{% endif %}">
                                                     {{ activity.item.decision|title }}
                                                 </span>
                                                 {% if activity.item.moderator_type == 'rule' and activity.item.rule %}
                                                     | Rule: {{ activity.item.rule.name }}
                                                 {% endif %}
                                             </small>
                                        {% endif %}
                                    </div>
                                    <div class="text-end">
                                        <small class="text-muted">{{ activity.time.strftime('%H:%M') }}</small>
                                        <br>
                                        <small class="text-muted">{{ activity.time.strftime('%Y-%m-%d') }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center">No activity to display.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block styles %}
<style>
.timeline {
    position: relative;
    padding-left: 30px;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 15px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: #e9ecef;
}

.timeline-item {
    position: relative;
    margin-bottom: 20px;
}

.timeline-marker {
    position: absolute;
    left: -22px;
    top: 0;
    width: 30px;
    height: 30px;
    background: white;
    border: 2px solid #e9ecef;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.timeline-content {
    background: #f8f9fa;
    padding: 15px;
    border-radius: 5px;
    border-left: 3px solid #007bff;
}
</style>
{% endblock %}
